<!DOCTYPE html>
<html>
    <head>
        <title>Connectify - New Post</title>
        <link rel="icon" href="resources/Logo.svg" type="image/svg+xml">
        <link rel="stylesheet" type="text/css" href="newPostPage.css">
    </head>

    <body>
        <header>
            <div id="headercol1">
                 <img id="logo" src="resources/Logo.svg" />
                 <p id="appName"> Connectify </p>
            </div>
            <div id="headercol2">
                 <div class="searchBar">
                      <img src="resources/Trailing-Elements.svg" alt="Search Icon">
                      <input type="text" id="search" name="search" placeholder="Search #tags or ::words::" required>
                 </div>
            </div>
       </header>

        <main>
            <div class="goBackLink" onclick="window.location.href='homePage.html'">
                <span class="arrow">&#8604;</span>
                <span class="back">Back</span>
            </div>

            <div class="post">
                <div class="postHeader">
                    <div class="userInfo">
                        <div class="avatar">C</div>
                        <div class="username">Username</div>
                    </div>
                </div>

                <!-- Tag Input Container (hidden by default) -->
                <div id="tagsContainer" class="tags" style="display: none;">
                    <div id="tagChips"></div>
                    <input 
                        type="text" 
                        id="tagsInput" 
                        placeholder="Type a tag, then press comma or enter"
                    />
                </div>

                <!-- Title input -->
                <div class="postTitle">
                    <input 
                        type="text" 
                        id="postTitleInput" 
                        placeholder="Enter your title"
                    />
                </div>

                <!-- Text area for the main post content (up to 300 chars) -->
                <div class="postText">
                    <textarea
                        id="postTextInput"
                        placeholder="What's on your mind?"
                        maxlength="300"
                    ></textarea>
                </div>

                <!-- Hidden file input for uploading images -->
                <input 
                    type="file" 
                    id="imageUploadInput" 
                    accept="image/*" 
                    multiple 
                    style="display: none;"
                />

                <!-- Container to display uploaded images -->
                <div class="postContent" id="postContentContainer"></div>

                <!-- Character limit display -->
                <div class="charLim">0/300</div>
                <div class="horizontalBar"></div>

                <!-- Post actions -->
                <div class="postActions">
                    <div class="actionButtonsLeft">
                        <!-- Add image button -->
                        <button class="actionButton" id="addImageButton">
                            <img src="resources/ImageAdd.svg" alt="Upload">
                        </button>
                        <!-- Add tag button -->
                        <button class="actionButton" id="addTagButton">
                            <img src="resources/Hash.svg" alt="Add Tag">
                        </button>
                    </div>

                    <!-- Post button -->
                    <button class="postButton">Post</button>
                </div>
            </div>
        </main>

        <script>
            /********************************
             * Real-time Character Limit
             ********************************/
            const postTextInput = document.getElementById("postTextInput");
            const charLim = document.querySelector(".charLim");
            
            postTextInput.addEventListener("input", function() {
                const currentLength = postTextInput.value.length;
                charLim.textContent = `${currentLength}/300`;
            });
            
            /********************************
             * Toggle Tag Input Visibility
             ********************************/
            const addTagButton = document.getElementById("addTagButton");
            const tagsContainer = document.getElementById("tagsContainer");
            
            addTagButton.addEventListener("click", function() {
                // Show/hide the tags container
                if (tagsContainer.style.display === "none") {
                    tagsContainer.style.display = "block";
                } else {
                    tagsContainer.style.display = "none";
                }
            });
            
            /********************************
             * Tags as Comma-Separated Chips
             ********************************/
            let tags = []; // We'll store the final list of tags here.
            const tagsInput = document.getElementById("tagsInput");
            const tagChips = document.getElementById("tagChips");
            
            // Function to render tags as chips
            function renderTags() {
                // Clear the chips container
                tagChips.innerHTML = "";
            
                tags.forEach((tag, index) => {
                    // Create a "chip" element
                    const chip = document.createElement("div");
                    chip.className = "tag-chip";
                    chip.innerText = tag;
            
                    // Create a remove icon for each chip
                    const removeIcon = document.createElement("span");
                    removeIcon.className = "remove-icon";
                    removeIcon.innerHTML = "&times;";
                    removeIcon.addEventListener("click", () => removeTag(index));
            
                    chip.appendChild(removeIcon);
                    tagChips.appendChild(chip);
                });
            }
            
            // Function to remove a tag
            function removeTag(index) {
                tags.splice(index, 1);
                renderTags();
            }
            
            // Listen for comma, enter, or blur (optional) to finalize a tag
            tagsInput.addEventListener("keydown", function(event) {
                if (event.key === "," || event.key === "Enter") {
                    event.preventDefault();
                    addTagFromInput();
                }
            });
            tagsInput.addEventListener("blur", addTagFromInput);
            
            // Helper to move input text to tags array
            function addTagFromInput() {
                let newTag = tagsInput.value.trim();
                
                // Remove trailing comma if user typed it
                if (newTag.endsWith(",")) {
                    newTag = newTag.slice(0, -1).trim();
                }
                
                // If non-empty, prepend "#" if missing
                if (newTag !== "") {
                    if (!newTag.startsWith("#")) {
                        newTag = "#" + newTag;
                    }
                    tags.push(newTag);
                    renderTags();
                    tagsInput.value = "";
                }
            }
            
            /********************************
             * Image Upload (Up to 4 images)
             ********************************/
            const imageUploadInput = document.getElementById("imageUploadInput");
            const postContentContainer = document.getElementById("postContentContainer");
            const addImageBtn = document.getElementById("addImageButton");
            
            // We'll store the preview image URLs in this array
            let images = [];
            
            // Trigger the hidden file input when "Add Image" is clicked
            addImageBtn.addEventListener("click", () => {
                imageUploadInput.click();
            });
            
            // Handle file selection
            imageUploadInput.addEventListener("change", handleImageUpload);
            
            function handleImageUpload(event) {
                const selectedFiles = Array.from(event.target.files);
            
                // Limit total images to 4
                selectedFiles.forEach((file) => {
                    if (images.length < 4) {
                        const imageURL = URL.createObjectURL(file);
                        images.push(imageURL);
                    }
                });
            
                renderImages();
            }
            
            // NEW: function to remove an image from the array
            function removeImage(index) {
                images.splice(index, 1);
                renderImages();
            }
            
            // Render images in the container
            function renderImages() {
                // Clear previous previews
                postContentContainer.innerHTML = "";
            
                // Decide layout based on image count
                if (images.length === 1) {
                    postContentContainer.classList.add("single-image");
                    postContentContainer.classList.remove("multi-images");
                } else if (images.length > 1) {
                    postContentContainer.classList.remove("single-image");
                    postContentContainer.classList.add("multi-images");
                } else {
                    // No images
                    postContentContainer.classList.remove("single-image", "multi-images");
                }
            
                // Create an element for each image with a remove icon
                images.forEach((url, index) => {
                    // Wrap each image + remove icon in a container
                    const imgWrapper = document.createElement("div");
                    imgWrapper.classList.add("imageWrapper");
                    
                    const img = document.createElement("img");
                    img.src = url;
            
                    // Create a remove icon for each image
                    const removeIcon = document.createElement("span");
                    removeIcon.classList.add("remove-image-icon");
                    removeIcon.innerHTML = "&times;";
                    removeIcon.addEventListener("click", () => removeImage(index));
            
                    // Append them together
                    imgWrapper.appendChild(img);
                    imgWrapper.appendChild(removeIcon);
                    postContentContainer.appendChild(imgWrapper);
                });
            }
        </script>        
    </body>
</html>
